<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Auditor칤a de Movimientos - Banco</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .currency-display { font-variant-numeric: tabular-nums; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-8">
    
    <div class="max-w-7xl mx-auto">
        <header class="mb-8">
            <h1 class="text-4xl font-extrabold text-gray-900 border-b pb-2">游낁 Auditor칤a de Movimientos (Vista Profesor)</h1>
            <p class="mt-2 text-gray-600">Detalle completo de todas las transacciones y movimientos entre usuarios.</p>
        </header>

        <div id="loading" class="text-center p-10">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500 mx-auto"></div>
            <p class="mt-4 text-xl font-semibold text-indigo-700">Cargando transacciones...</p>
        </div>

        <div id="transactions-container" class="bg-white shadow-xl rounded-xl overflow-hidden hidden">
            </div>

        <div id="error-message" class="hidden p-6 bg-red-100 text-red-800 rounded-lg mt-8">
            <p class="font-bold">Hubo un error al cargar los datos.</p>
            <p class="text-sm mt-2">Por favor, revisa la Consola del Navegador (F12) para ver el mensaje de error de Firebase.</p>
        </div>
        
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script>
        // === 游댠 CONFIGURACI칍N DE FIREBASE (MISMA DE LA APP PRINCIPAL) ===
        const firebaseConfig = {
            apiKey: "AIzaSyDbxqbqjn8ZdCzLUNWyuM2gNMTtVw_-zcI",
            authDomain: "feria-escolar-billetera.firebaseapp.com",
            projectId: "feria-escolar-billetera",
            storageBucket: "feria-escolar-billetera.firebasestorage.app",
            messagingSenderId: "311026746803",
            appId: "1:311026746803:web:fc891c988b9da3faee37c6"
        };

        let db = null;
        let userMap = {}; // Para mapear ID a nombre

        // === FUNCI칍N PRINCIPAL DE CARGA ===
        window.onload = () => {
            try {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                loadTransactionsView();
            } catch (e) {
                console.error("Error al inicializar Firebase:", e);
                document.getElementById("loading").classList.add("hidden");
                // Mostrar el error detallado
                const errorDiv = document.getElementById("error-message");
                errorDiv.classList.remove("hidden");
                errorDiv.innerHTML = `
                    <p class="font-bold">Error al inicializar Firebase.</p>
                    <p class="text-sm mt-2">Por favor, revisa la Consola del Navegador (F12) para ver el mensaje de error de Firebase.</p>
                    <p class="text-xs mt-2 break-all">Detalle: ${e.message || e}</p>
                `;
            }
        };

        async function loadTransactionsView() {
            const loadingDiv = document.getElementById("loading");
            const errorDiv = document.getElementById("error-message");
            const container = document.getElementById('transactions-container');
            
            try {
                loadingDiv.classList.add("hidden");
                errorDiv.classList.add("hidden"); // Ocultar mensaje de error anterior
                container.classList.add("hidden");
                
                // 1. Cargar el mapa de usuarios (ID -> Nombre)
                const usersSnapshot = await db.collection("usuarios").get();
                usersSnapshot.forEach(doc => {
                    userMap[doc.id] = doc.data().nombre;
                });
                
                // 2. Cargar las transacciones, ordenadas por fecha descendente
                const transactionsSnapshot = await db.collection("transacciones")
                    .orderBy("fecha", "desc")
                    .get();

                const transactions = [];
                transactionsSnapshot.forEach(doc => {
                    transactions.push(doc.data());
                });

                // 3. Renderizar la tabla
                renderTransactions(transactions);

            } catch (e) {
                console.error("Error al cargar transacciones:", e);
                container.classList.add("hidden");
                
                // Mostrar el error detallado
                errorDiv.classList.remove("hidden");
                errorDiv.innerHTML = `
                    <p class="font-bold">Error al cargar los datos.</p>
                    <p class="text-sm mt-2">
                        El error puede ser por un **칤ndice de Firestore** faltante (revisa la consola en busca de un enlace) o por un dato corrupto.
                    </p>
                    <p class="text-xs mt-2 break-all">Detalle de error: ${e.message || e}</p>
                `;
            }
        }

        function renderTransactions(transactions) {
            const container = document.getElementById('transactions-container');
            if (transactions.length === 0) {
                container.innerHTML = '<p class="p-6 text-gray-500 text-center">No hay transacciones registradas.</p>';
                container.classList.remove("hidden");
                return;
            }

            const formatCurrency = (value) => {
                // Se asegura de que el valor sea un n칰mero antes de formatear
                if (typeof value !== 'number' || isNaN(value)) return '$0.00'; 
                return value.toLocaleString('es-CL', { style: 'currency', currency: 'CLP', minimumFractionDigits: 2, maximumFractionDigits: 2 });
            };
            
            // FUNCI칍N CORREGIDA para manejar valores nulos/undefined
            const formatDate = (date) => {
                if (!date || !date.toDate) return 'N/A';
                
                let dateObject;
                try {
                    // Intenta convertir el Timestamp de Firebase a Date
                    dateObject = date.toDate();
                } catch (e) {
                    console.error("Error al convertir fecha:", e);
                    return 'Fecha Inv치lida';
                }
                
                return dateObject.toLocaleString('es-CL', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            };

            let tableHTML = `
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Emisor (ID)</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Receptor (ID)</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Monto Transado</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Comisi칩n (5%)</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Neto Recibido</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
            `;

            transactions.forEach(t => {
                const emisorNombre = userMap[t.emisor] || `ID: ${t.emisor}`;
                const receptorNombre = userMap[t.receptor] || `ID: ${t.receptor}`;
                // Se asegura que monto y comisi칩n existan para el c치lculo
                const monto = t.monto || 0; 
                const comision = t.comision || 0;
                const montoRecibido = monto - comision;

                // Estilo para destacar la fila de la comisi칩n
                const rowClass = comision > 0 ? 'bg-yellow-50 hover:bg-yellow-100' : 'hover:bg-gray-50';
                
                tableHTML += `
                    <tr class="${rowClass}">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(t.fecha)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 capitalize">${t.tipo || 'Desconocido'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${emisorNombre} <span class="text-xs text-gray-400">(${t.emisor || 'N/A'})</span></td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${receptorNombre} <span class="text-xs text-gray-400">(${t.receptor || 'N/A'})</span></td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-right text-indigo-600">${formatCurrency(monto)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right ${comision > 0 ? 'text-red-500 font-bold' : 'text-gray-500'}">${formatCurrency(comision)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-right text-green-600">${formatCurrency(montoRecibido)}</td>
                    </tr>
                `;
            });

            tableHTML += `
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = tableHTML;
            container.classList.remove("hidden");
        }
    </script>
</body>
</html>
