<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <title>Billetera Feria Escolar</title>
  <!-- Carga de Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { 
      font-family: 'Inter', sans-serif; 
      overflow: hidden; 
      height: 100vh; 
      margin: 0; 
      padding: 0; 
    }
    .currency-display { font-variant-numeric: tabular-nums; }
    /* Estilo para asegurar que el canvas del QR sea visible y se centre */
    #qr-code-container > canvas,
    #qr-pago-container > canvas {
        margin: 0 auto;
        display: block;
        width: 220px !important; 
        height: 220px !important;
    }
    /* Estilo para el contenedor de la app que ahora ocupa toda la pantalla */
    #app-container {
        width: 100%;
        height: 100vh;
        padding: 0;
        margin: 0;
        background-color: #f3f4f6; /* bg-gray-100 */
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: center;
        overflow-y: auto;
    }
    /* Estilo para el contenido interno de cada vista */
    .app-content {
        width: 100%;
        max-width: 600px; /* Equivalente a max-w-lg */
        padding: 1rem; /* p-4 */
        background-color: white; /* bg-white */
        border-radius: 0.75rem; /* rounded-xl */
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); /* shadow-2xl */
        margin-top: 1rem; /* mt-4 */
        margin-bottom: 1rem; /* mb-4 */
        transition: all 0.3s ease-in-out;
    }
    /* Estilos para la vista de escaneo */
    #scanner-container {
        width: 100%;
        max-width: 600px;
        height: 100vh;
        display: flex;
        flex-direction: column;
        background-color: black;
        color: white;
        align-items: center;
        justify-content: flex-start; /* Ajustado para dejar espacio arriba */
        padding-top: 1rem; /* Añadido padding superior */
    }
    #scanner-container video {
        width: 100%;
        max-width: 500px;
        height: auto;
        object-fit: cover;
        border-radius: 0.5rem; /* Opcional: bordes redondeados */
    }
    #scanner-overlay {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 80%;
        height: 80%;
        border: 2px solid #00ff00; /* Verde para el marco */
        pointer-events: none;
    }
    #scanner-controls {
        position: relative; /* Cambiado de absolute a relative */
        bottom: auto; /* Removido */
        width: 100%;
        display: flex;
        justify-content: center;
        margin-top: 1rem; /* Espacio debajo del video */
    }
    #scanner-controls button {
        margin: 0 0.5rem;
    }
    #scanner-message {
        margin-top: 1rem; /* Espacio debajo de los controles */
        width: 100%;
        text-align: center;
        /* Ajuste de color para visibilidad */
        color: white;
        font-weight: bold;
        font-size: 1rem;
    }
    /* Canvas oculto */
    #scanner-canvas {
        display: none;
    }
  </style>
</head>
<body class="bg-gray-100">

  <div id="app-container">
    <!-- Contenido de la aplicación -->
  </div>

  <!-- Scripts de Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- Librería QRCode.js -->
  <script src="https://unpkg.com/qrcodejs@1.0.0/qrcode.min.js"></script>

  <!-- Librería jsQR para escaneo -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

  <!-- Incluir vistas -->
  <script src="views/home.js"></script>
  <script src="views/pago.js"></script>
  <script src="views/qr.js"></script>
  <script src="views/qrPago.js"></script>
  <script src="views/escanear.js"></script>
  <script src="views/transfer.js"></script>
  <script src="views/registro.js"></script>
  <script src="views/notFound.js"></script>

  <!-- Incluir lógica principal -->
  <script src="logic/main.js"></script>

  <script>
    // === VISTAS ===
    let currentView = 'loading';
    let message = { text: '', type: '' };

    const renderApp = () => {
      let content = '';

      if (currentView === 'loading') {
        content = `
          <div class="flex items-center justify-center h-full w-full">
            <div class="flex flex-col items-center justify-center p-10">
              <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-500"></div>
              <p class="mt-4 text-xl font-semibold text-indigo-700">Cargando la aplicación...</p>
              <p class="text-sm text-gray-500 mt-2">ID: ${userId || 'Cargando...'}</p>
            </div>
          </div>
        `;
      } else {
        // Cada vista ahora se envuelve en un div con clase 'app-content'
        switch (currentView) {
          case 'home':
            content = `<div class="app-content">${getHomeView()}</div>`;
            break;
          case 'registro':
            content = `<div class="app-content">${getRegistroView()}</div>`;
            break;
          case 'pago':
            content = `<div class="app-content">${getPagoView()}</div>`;
            break;
          case 'qr':
            content = `<div class="app-content">${getQRView()}</div>`;
            break;
          case 'qrPago':
            content = `<div class="app-content">${getQRPagoView()}</div>`;
            break;
          case 'transfer':
            content = `<div class="app-content">${getTransferView()}</div>`;
            break;
          case 'escanear':
            content = getEscanearView(); // Vista sin app-content
            break;
          default:
            content = `<div class="app-content">${getNotFoundView()}</div>`;
            break;
        }
      }

      document.getElementById('app-container').innerHTML = content;

      // Mostrar mensaje - Ahora se añade fuera del app-content si es necesario
      if (message.text) {
        const messageElement = document.createElement('div');
        messageElement.id = 'app-message';
        const baseClasses = "p-3 rounded-lg text-sm font-medium transition-opacity duration-500 ease-in-out fixed top-4 left-1/2 transform -translate-x-1/2 z-50 max-w-md w-full";
        let styleClass = message.type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
        messageElement.className = `${baseClasses} ${styleClass} opacity-100`;
        messageElement.textContent = message.text;
        document.getElementById('app-container').appendChild(messageElement);

        // Ocultar después de un tiempo
        setTimeout(() => {
          if(messageElement.parentNode) messageElement.parentNode.removeChild(messageElement);
          message.text = '';
        }, 4000);
      }

      // Despues de renderizar, si es necesario, actualizar vistas QR
      if (currentView === 'qr') {
        setTimeout(updateQRView, 0);
      }
      if (currentView === 'qrPago') {
        setTimeout(updateQRPagoView, 0);
      }
      if (currentView === 'escanear') {
        setTimeout(iniciarEscaneo, 0);
      }
      // Cargar datos escaneados DESPUÉS de renderizar la vista de pago
      if (currentView === 'pago') {
          setTimeout(cargarDatosEscaneados, 0);
      }
    };

    window.switchView = (newView) => {
        if (newView === 'home' && window.tempPagoData) {
            delete window.tempPagoData; // Limpiar datos temporales al ir a home
        }
        if (currentView === 'escanear') { // <-- ESTA PARTE ES CRUCIAL
            detenerEscaneo(); // Detiene escaneo al salir
        }
        currentView = newView;
        message = { text: '', type: '' };
        renderApp();
        if (currentView === 'qr') {
            setTimeout(updateQRView, 0);
        }
        if (currentView === 'qrPago') {
            setTimeout(updateQRPagoView, 0);
        }
        if (currentView === 'escanear') {
            setTimeout(iniciarEscaneo, 0);
        }
    };

    // Iniciar renderizado
    if (db) renderApp();
  </script>

</body>
</html>
